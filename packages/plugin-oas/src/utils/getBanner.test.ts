import type { Config } from "@kubb/core";
import type { OasTypes } from "@kubb/oas";
import { parse } from "@kubb/oas";
import { describe, expect, test } from "vitest";
import { getBanner } from "./getBanner.ts";

describe("getBanner", () => {
  test("should generate default banner with path input", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {
        title: "Test API",
        description: "Test Description",
        version: "1.0.0",
      },
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: true },
    } as unknown as Config;

    const result = getBanner({
      oas,
      output: {
        path: "./output",
      },
      config,
    });

    expect(result).toContain("Generated by Kubb");
    expect(result).toContain("Title: Test API");
    expect(result).toContain("Description: Test Description");
    expect(result).toContain("OpenAPI spec version: 1.0.0");
    expect(result).toContain("Source: api.yaml");
  });

  test("should generate simple banner", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {
        title: "Test API",
        version: "1.0.0",
      },
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: "simple" },
    } as unknown as Config;

    const result = getBanner({
      oas,
      output: { path: "./output" },
      config,
    });

    expect(result).toContain("Generated by Kubb");
    expect(result).not.toContain("Title:");
    expect(result).not.toContain("Source:");
  });

  test("should handle data input", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {
        title: "Test API",
        version: "1.0.0",
      },
    } as OasTypes.OASDocument);

    const config = {
      input: { data: "openapi spec content" },
      output: { path: "./output", defaultBanner: true },
    } as unknown as Config;

    const result = getBanner({
      oas,
      output: { path: "./output" },
      config,
    });

    expect(result).toContain("Source: text content");
  });

  test("should handle custom string banner", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {},
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: true },
    } as unknown as Config;

    const customBanner = "// Custom banner";
    const result = getBanner({
      oas,
      output: { path: "./output", banner: customBanner },
      config,
    });

    expect(result).toContain(customBanner);
    expect(result).toContain("Generated by Kubb");
  });

  test("should handle custom function banner", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {},
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: true },
    } as unknown as Config;

    const bannerFn = () => "// Function generated banner";
    const result = getBanner({
      oas,
      output: { path: "./output", banner: bannerFn },
      config,
    });

    expect(result).toContain("Function generated banner");
    expect(result).toContain("Generated by Kubb");
  });

  test("should return empty string when defaultBanner is false", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {
        title: "Test API",
      },
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: false },
    } as unknown as Config;

    const result = getBanner({
      oas,
      output: {
        path: "./output",
      },
      config,
    });

    expect(result).toBe("");
  });

  test("should handle multiline description", async () => {
    const oas = await parse({
      openapi: "3.0.0",
      info: {
        title: "Test API",
        description: "Line 1\nLine 2\nLine 3",
        version: "1.0.0",
      },
    } as OasTypes.OASDocument);

    const config = {
      input: { path: "/path/to/api.yaml" },
      output: { path: "./output", defaultBanner: true },
    } as unknown as Config;

    const result = getBanner({
      oas,
      output: {
        path: "./output",
      },
      config,
    });

    expect(result).toContain("Line 1");
    expect(result).toContain("* Line 2");
    expect(result).toContain("* Line 3");
  });
});
