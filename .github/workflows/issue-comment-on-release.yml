name: Comment on Issues Fixed in Release

on:
  release:
    types: [published]

permissions:
  issues: write
  pull-requests: read

jobs:
  comment-on-issues:
    name: Comment on Fixed Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Comment on issues fixed in this release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseTag = context.payload.release.tag_name;
            const releaseName = context.payload.release.name || releaseTag;
            const releaseUrl = context.payload.release.html_url;
            
            console.log(`Processing release: ${releaseName} (${releaseTag})`);
            
            // Get the release body which contains PR information
            const releaseBody = context.payload.release.body || '';
            
            // Extract PR numbers from the release body
            // Changesets typically format PRs as #123 or PR #123
            const prPattern = /#(\d+)/g;
            const prNumbers = new Set();
            let match;
            
            while ((match = prPattern.exec(releaseBody)) !== null) {
              prNumbers.add(parseInt(match[1]));
            }
            
            console.log(`Found ${prNumbers.size} PRs in release notes`);
            
            // For each PR, find linked issues
            const issuesSet = new Set();
            
            for (const prNumber of prNumbers) {
              try {
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                console.log(`Checking PR #${prNumber}: ${pr.title}`);
                
                // Extract issue references from PR body and title
                // Common patterns: "fixes #123", "closes #456", "resolves #789", "#123"
                const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)|#(\d+)/gi;
                const prText = `${pr.title} ${pr.body || ''}`;
                let issueMatch;
                
                while ((issueMatch = issuePattern.exec(prText)) !== null) {
                  const issueNumber = issueMatch[1] || issueMatch[2];
                  if (issueNumber) {
                    issuesSet.add({
                      number: parseInt(issueNumber),
                      prNumber: prNumber,
                      prTitle: pr.title
                    });
                  }
                }
                
                // Also check timeline events for linked issues
                try {
                  const { data: timelineEvents } = await github.rest.issues.listEventsForTimeline({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber
                  });
                  
                  for (const event of timelineEvents) {
                    if (event.event === 'cross-referenced' && event.source?.issue) {
                      const linkedIssue = event.source.issue;
                      if (!linkedIssue.pull_request) {
                        issuesSet.add({
                          number: linkedIssue.number,
                          prNumber: prNumber,
                          prTitle: pr.title
                        });
                      }
                    }
                  }
                } catch (error) {
                  console.log(`Could not fetch timeline for PR #${prNumber}: ${error.message}`);
                }
                
              } catch (error) {
                console.log(`Error processing PR #${prNumber}: ${error.message}`);
              }
            }
            
            console.log(`Found ${issuesSet.size} issues to comment on`);
            
            // Comment on each issue
            const docsUrl = 'https://kubb.dev';
            const changelogUrl = `${docsUrl}/changelog`;
            
            for (const issue of issuesSet) {
              try {
                // Check if issue is open
                const { data: issueData } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                if (issueData.state === 'open') {
                  console.log(`Skipping open issue #${issue.number}`);
                  continue;
                }
                
                const commentBody = [
                  `üéâ This issue has been resolved in version **${releaseName}**!`,
                  '',
                  `The fix was included in PR #${issue.prNumber}.`,
                  '',
                  'For more details, check out:',
                  `- üì¶ [Release Notes](${releaseUrl})`,
                  `- üìñ [Changelog](${changelogUrl})`,
                  `- üìö [Documentation](${docsUrl})`,
                  '',
                  'Thank you for reporting this issue!'
                ].join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                });
                
                console.log(`‚úÖ Commented on issue #${issue.number}`);
              } catch (error) {
                console.log(`‚ùå Error commenting on issue #${issue.number}: ${error.message}`);
              }
            }
            
            console.log('Finished processing all issues');
