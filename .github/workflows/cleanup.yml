name: Cleanup

on:
  schedule:
    - cron: '0 0 * * 0' # Runs every Sunday at 00:00 UTC
  workflow_dispatch:     # Allows manual run

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: lock-threads

jobs:
  stale:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Ghosting
        uses: actions/stale@v10
        with:
          days-before-close: 10
          close-issue-message: >
            [AUTOMATION] ‚öôÔ∏è This issue has been automatically closed due to original author
            inactivity/non-response. This process is executed to maintain a clean and
            actionable issue tracker, ensuring the integrity of the project backlog.
            If you have relevant new information, please comment, and the issue will be
            reopened for processing. üöÄ

          close-pr-message: >
            [AUTOMATION] üîí This pull request has been automatically closed due to original
            author inactivity/non-response. This process is executed to maintain a clean
            and actionable PR queue, ensuring the integrity of the project contribution
            stream. If you have relevant new information, please comment, and the PR will
            be available for re-evaluation. ü§ù
          # don't automatically mark issues/PRs as stale
          days-before-stale: -1
          stale-issue-label: needs-response
          stale-pr-label: needs-response
  tags:
    name: Delete old tags and releases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Delete old releases (1 year+)
        uses: freenet-actions/delete-old-releases@v1
        with:
          max-age: 'P1Y' # Delete all releases older than 1 year.
          token: '${{ github.token }}'
          delete-tags: true

      - name: Delete old tags (1 year+)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          now=$(date +%s)
          threshold=$((365 * 24 * 60 * 60))

          git fetch --tags

          git for-each-ref --sort=creatordate --format '%(refname:strip=2) %(creatordate:iso8601)' refs/tags | while read tag date; do
            tag_seconds=$(date -d "$date" +%s)
            age=$((now - tag_seconds))

            if [ "$age" -gt "$threshold" ]; then
              echo "üóëÔ∏è Deleting tag: $tag (created on $date)"
              git tag -d "$tag"
              git push origin ":refs/tags/$tag"
            fi
          done
  lock:
    runs-on: ubuntu-latest
    steps:
      - uses: dessant/lock-threads@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-inactive-days: 1
          pr-inactive-days: 1
          log-output: true
          issue-comment: 'This issue has been locked because we are very unlikely to see comments on closed issues. If you are running into a similar issue, please create a new issue. Thank you.'
          pr-comment: 'This pull request has been locked because we are very unlikely to see comments on closed issues. If you think, this PR is still necessary, create a new one with the same branch. Thank you.'
